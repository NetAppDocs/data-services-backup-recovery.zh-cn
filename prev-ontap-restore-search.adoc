---
sidebar: sidebar 
permalink: prev-ontap-restore-search.html 
keywords: backing up, back up, backup, backup application data, Amazon Web services, AWS, NetApp Backup and Recovery, Oracle database, Microsoft SQL Server database, SAP HANA database 
summary: 您可以使用搜索和恢复功能从ONTAP备份文件中恢复卷、文件夹或文件。 
---
= 使用搜索和恢复功能从ONTAP备份恢复
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
您可以使用搜索和恢复功能从ONTAP备份文件中恢复卷、文件夹或文件。搜索和恢复功能允许您搜索所有备份（包括本地快照、复制卷和对象存储），而无需提供确切的系统、卷或文件名。

从本地快照或复制卷恢复通常比从对象存储恢复更快、更便宜。

恢复整个卷时， NetApp Backup and Recovery会使用备份数据创建一个新卷。您可以恢复到原始系统、同一云帐户内的另一个系统或本地ONTAP系统。文件夹和文件可以恢复到其原始位置、同一系统中的不同卷、同一云帐户中的另一个系统或本地系统。

恢复功能取决于您的ONTAP版本：

* *文件夹：* 使用ONTAP 9.13.0 或更高版本，您可以恢复包含所有文件和子文件夹的文件夹；使用早期版本，您只能恢复文件夹中的文件。
* *归档存储：*从归档存储恢复（ ONTAP 9.10.1 或更高版本可用）速度较慢，并且可能会产生额外费用。
* *目标集群要求：*
+
** 卷恢复： ONTAP 9.10.1 或更高版本
** 文件恢复： ONTAP 9.11.1 或更高版本
** Google Archive 和StorageGRID： ONTAP 9.12.1 或更高版本
** 文件夹恢复： ONTAP 9.13.1 或更高版本




link:prev-reference-aws-archive-storage-tiers.html["了解有关从 AWS 档案存储恢复的更多信息"]。link:prev-reference-azure-archive-storage-tiers.html["了解有关从 Azure 档案存储还原的详细信息"]。link:prev-reference-gcp-archive-storage-tiers.html["详细了解如何从 Google 存档存储中恢复"]。

[NOTE]
====
* 如果对象存储中的备份文件已配置 DataLock 和勒索软件保护，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从备份文件恢复整个卷，然后访问所需的文件夹和文件。
* 如果对象存储中的备份文件驻留在档案存储中，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从尚未存档的较新备份文件中还原文件夹，也可以从存档的备份中还原整个卷，然后访问所需的文件夹和文件。
* 将数据从 Azure 档案存储还原到StorageGRID系统时，不支持“高”还原优先级。
* 目前不支持从ONTAP S3 对象存储中的卷还原文件夹。


====
在开始之前，您应该对要还原的卷或文件的名称或位置有所了解。



== 搜索和恢复支持的系统和对象存储提供商

您可以将ONTAP数据从位于二级系统（复制卷）或对象存储（备份文件）中的备份文件还原到以下系统。快照保存在源系统上，并且只能还原到同一系统。

*注意：*您可以从任何类型的备份文件恢复卷和文件，但目前只能从对象存储中的备份文件恢复文件夹。

[cols="33,33,33"]
|===
2+| 备份文件位置 | 目的地系统 


| *对象存储（备份）* | *辅助系统（复制）* |  


| Amazon S3 | AWS 本地ONTAP系统中的Cloud Volumes ONTAP | AWS 本地ONTAP系统中的Cloud Volumes ONTAP 


| Azure Blob | Azure 本地ONTAP系统中的Cloud Volumes ONTAP | Azure 本地ONTAP系统中的Cloud Volumes ONTAP 


| Google Cloud Storage | Google 本地ONTAP系统中的Cloud Volumes ONTAP | Google 本地ONTAP系统中的Cloud Volumes ONTAP 


| NetAppStorageGRID | 本地ONTAP系统Cloud Volumes ONTAP | 本地ONTAP系统 


| ONTAP S3 | 本地ONTAP系统Cloud Volumes ONTAP | 本地ONTAP系统 
|===
对于搜索和还原，控制台代理可以安装在以下位置：

* 对于 Amazon S3，控制台代理可以部署在 AWS 或您的场所
* 对于 Azure Blob，控制台代理可以部署在 Azure 中或您的本地
* 对于 Google Cloud Storage，控制台代理必须部署在您的 Google Cloud Platform VPC 中
* 对于StorageGRID，控制台代理必须部署在您的场所；无论是否有互联网访问
* 对于ONTAP S3，控制台代理可以部署在您的场所（有或没有互联网访问）或云提供商环境中


请注意，“本地ONTAP系统”包括FAS、 AFF和ONTAP Select系统。



== 搜索与恢复的先决条件

启用搜索和恢复功能前，请确保您的环境满足以下要求：

* 集群要求：
+
** ONTAP版本必须为 9.8 或更高版本。
** 卷所在的存储虚拟机 (SVM) 必须具有配置的数据 LIF。
** 必须在卷上启用 NFS（支持 NFS 和 SMB/CIFS 卷）。
** 必须在 SVM 上激活 SnapDiff RPC 服务器。当您在系统上启用索引时，控制台会自动执行此操作。（SnapDiff 是一种能够快速识别快照之间文件和目录差异的技术。）


* NetApp建议在控制台代理上挂载单独的卷，以提高搜索和恢复的弹性。有关说明，请参阅<<mount-volume-steps,挂载卷以重新索引目录>>。




=== 旧版搜索与恢复的先决条件（使用索引目录 v1）

以下是使用传统索引时搜索和恢复功能的要求：

[%collapsible]
====
* AWS 要求：
+
** 必须将特定的 Amazon Athena、AWS Glue 和 AWS S3 权限添加到为控制台提供权限的用户角色。link:prev-ontap-backup-onprem-aws.html["确保所有权限均已正确配置"]。
+
请注意，如果您已经使用NetApp Backup and Recovery以及您过去配置的控制台代理，则现在需要将 Athena 和 Glue 权限添加到控制台用户角色。它们是搜索和恢复所必需的。





* Azure 要求：
+
** 您必须向您的订阅注册 Azure Synapse Analytics 资源提供程序（称为“Microsoft.Synapse”）。 https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types#register-resource-provider["了解如何为您的订阅注册此资源提供程序"^] 。您必须是订阅*所有者*或*贡献者*才能注册资源提供者。
** 必须将特定的 Azure Synapse Workspace 和 Data Lake Storage 帐户权限添加到为控制台提供权限的用户角色。link:prev-ontap-backup-onprem-azure.html["确保所有权限均已正确配置"]。
+
请注意，如果您已经使用过去配置的控制台代理来使用NetApp Backup and Recovery ，则现在需要将 Azure Synapse Workspace 和 Data Lake Storage 帐户权限添加到控制台用户角色。它们是搜索和恢复所必需的。

** 控制台代理必须配置为*不带*代理服务器才能与互联网进行 HTTP 通信。如果您已为控制台代理配置了 HTTP 代理服务器，则无法使用搜索和还原功能。




* Google Cloud 要求：
+
** 必须将特定的 Google BigQuery 权限添加到为NetApp Console提供权限的用户角色。link:prev-ontap-backup-onprem-gcp.html["确保所有权限均已正确配置"]。
+
如果您已经使用NetApp Backup and Recovery以及您过去配置的控制台代理，则现在需要将 BigQuery 权限添加到控制台用户角色。它们是搜索和恢复所必需的。



* StorageGRID和ONTAP S3 要求：
+
根据您的配置，有两种方法可以实现“搜索和还原”：

+
** 如果您的帐户中没有云提供商凭据，则索引目录信息将存储在控制台代理上。
+
有关索引目录 v2 的信息，请参阅下面有关如何启用索引目录的部分。

** 如果您在私人（暗）站点中使用控制台代理，则索引目录信息将存储在控制台代理上（需要控制台代理版本 3.9.25 或更高版本）。
** 如果你有 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-aws.html["AWS 凭证"^]或者 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-azure.html["Azure 凭据"^]在帐户中，索引目录存储在云提供商处，就像在云中部署控制台代理一样。  （如果您拥有这两个凭证，则默认选择 AWS。）
+
即使您使用的是本地控制台代理，也必须满足控制台代理权限和云提供商资源的云提供商要求。使用此实现时，请参阅上面的 AWS 和 Azure 要求。





====


== 搜索和恢复过程

这个过程如下：

. 在使用搜索和还原之前，您需要在要从中还原卷数据的每个源系统上启用“索引”。这使得索引目录可以跟踪每个卷的备份文件。
. 当您想要从卷备份中恢复卷或文件时，在“搜索和恢复”下选择“*搜索和恢复*”。
. 通过部分或完整卷名、部分或完整文件名、备份位置、大小范围、创建日期范围、其他搜索过滤器输入卷、文件夹或文件的搜索条件，然后选择*搜索*。
+
搜索结果页面显示具有符合搜索条件的文件或卷的所有位置。

. 选择要用于恢复卷或文件的位置的“查看所有备份”，然后在要使用的实际备份文件上选择“恢复”。
. 选择您想要恢复卷、文件夹或文件的位置，然后选择*恢复*。
. 卷、文件夹或文件已恢复。


image:diagram_search_restore_vol_file.png["该图显示了使用“搜索和还原”执行卷、文件夹或文件还原操作的流程。"]

您只需要知道部分名称， NetApp Backup and Recovery就会搜索所有与您的搜索匹配的备份文件。



== 为每个系统启用索引目录

在使用搜索和还原之前，您需要在计划还原卷或文件的每个源系统上启用“索引”。这使得索引目录可以跟踪每个卷和每个备份文件 - 使您的搜索非常快速和高效。

索引目录是一个数据库，用于存储系统中所有卷和备份文件的元数据。搜索和恢复功能使用它来快速找到包含要恢复的数据的备份文件。

.索引目录功能
使用索引目录时， NetApp Backup and Recovery不会配置单独的存储桶。相反，对于存储在 AWS、Azure、Google Cloud Platform、 StorageGRID或ONTAP S3 中的备份，该服务会在控制台代理或云提供商环境上提供空间。

索引目录支持以下功能：

* 3分钟内即可实现全球搜索效率
* 最多 50 亿个文件
* 每个集群最多 5000 个卷
* 每个卷最多 10 万个快照
* 基线索引的最长时间少于 7 天。实际时间将根据您的环境而有所不同。


.为系统启用索引的步骤：
如果您的系统已启用索引，请转到下一部分来恢复您的数据。

您首先需要挂载一个单独的卷来存放目录文件。这样可以防止因保存快照的文件过大而导致数据丢失。并非每个集群都需要这样做；您可以从环境中的任何集群挂载任何一个卷。如果不这样做，索引可能无法正常工作。

对于装订体积，请参考以下尺寸指南：

* 使用NetApp NFS 卷
* 推荐使用磁盘吞吐量为 300 MB/s 的AFF存储。吞吐量降低会影响搜索和其他操作。
* 启用NetApp快照功能，除了保护目录备份 zip 文件外，还可以保护目录元数据。
* 每10亿个文件占用50GB空间
* 目录数据占用 20 GB 空间，另有空间用于创建 zip 文件和存放临时文件。


[[mount-volume-steps]]
.挂载卷以重新索引目录的步骤
. 将卷挂载到 `/opt/application/netapp/cbs` 输入以下命令，其中：
+
** `volume name` 这是集群上用于存储目录文件的卷。
** `/opt/application/netapp/cbs` 这是它安装的路径。
+
[source, console]
----
mount <cluster IP address>:/<volume name> /opt/application/netapp/cbs
----
+
示例：

+
[source, console]
----
mount 10.192.24.17:/CATALOG_SCALE_234 /opt/application/netapp/cbs
----




.启用索引的步骤
. 执行以下操作之一：
+
** 如果没有系统被索引，请在“恢复仪表板”的“搜索和恢复”下，选择“启用系统索引”。
** 如果至少有一个系统已被索引，请在“搜索和恢复”下的“恢复仪表板”上选择“索引设置”。


. 为系统选择*启用索引*。


.结果
在所有服务都配置完毕并且索引目录被激活后，系统将显示为“活动”状态。

根据系统中卷的大小以及所有 3 个备份位置的备份文件数量，初始索引过程可能需要长达一个小时。此后，它会每小时透明地更新，并进行增量更改以保持最新状态。



== 使用“搜索和还原”功能还原卷、文件夹和文件

之后<<enable-the-indexed-catalog-for-each-system,为您的系统启用索引>>，您可以使用“搜索和还原”还原卷、文件夹和文件。这使您可以使用广泛的过滤器从所有备份文件中找到要恢复的确切文件或卷。

.步骤
. 从控制台菜单中，选择*保护>备份和恢复*。
. 选择“*恢复*”选项卡，将显示“恢复仪表板”。
. 从“搜索和恢复”部分，选择“搜索和恢复”。
. 从“搜索和恢复”部分，选择“搜索和恢复”。
. 从“搜索和还原”页面：
+
.. 在“搜索栏”中，输入完整或部分卷名、文件夹名或文件名。
.. 选择资源类型：*卷*、*文件*、*文件夹*或*全部*。
.. 在“过滤依据”区域中，选择过滤条件。例如，您可以选择数据所在的系统和文件类型，例如 .JPEG 文件。或者，如果您只想在对象存储中的可用快照或备份文件中搜索结果，则可以选择备份位置类型。


. 选择*搜索*，搜索结果区域将显示所有具有与您的搜索相匹配的文件、文件夹或卷的资源。
. 找到包含您要恢复的数据的资源，然后选择“查看所有备份”以显示包含匹配卷、文件夹或文件的所有备份文件。
. 找到您想要用于恢复数据的备份文件并选择*恢复*。
+
请注意，搜索结果会识别包含您搜索文件的本地卷快照和远程复制卷。您可以选择从云备份文件、快照或复制卷中恢复。

. 选择要恢复卷、文件夹或文件的目标位置，然后选择*恢复*。
+
** 对于卷，您可以选择原始目标系统，也可以选择备用系统。恢复FlexGroup卷时，您需要选择多个聚合。
** 对于文件夹，您可以恢复到原始位置，也可以选择备用位置；包括系统、卷和文件夹。
** 对于文件，您可以恢复到原始位置，也可以选择备用位置；包括系统、卷和文件夹。选择原始位置时，您可以选择覆盖源文件或创建新文件。
+
如果您选择本地ONTAP系统，并且尚未配置与对象存储的集群连接，系统将提示您输入其他信息：

+
*** 从 Amazon S3 还原时，选择ONTAP集群中目标卷所在的 IP 空间，输入您创建的用户的访问密钥和密钥，以授予ONTAP集群对 S3 存储桶的访问权限，并可选择选择私有 VPC 端点以进行安全数据传输。link:prev-ontap-backup-onprem-aws.html["查看有关这些要求的详细信息"]。
*** 从 Azure Blob 还原时，选择目标卷所在的ONTAP集群中的 IP 空间，并通过选择 VNet 和子网来选择用于安全数据传输的私有端点。link:prev-ontap-backup-onprem-azure.html["查看有关这些要求的详细信息"]。
*** 从 Google Cloud Storage 恢复时，选择目标卷所在的ONTAP集群中的 IP 空间，以及用于访问对象存储的访问密钥和密钥。link:prev-ontap-backup-onprem-gcp.html["查看有关这些要求的详细信息"]。
*** 从StorageGRID还原时，输入StorageGRID服务器的 FQDN 和ONTAP应用于与StorageGRID进行 HTTPS 通信的端口，输入访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。link:prev-ontap-backup-onprem-storagegrid.html["查看有关这些要求的详细信息"]。
*** 从ONTAP S3 还原时，输入ONTAP S3 服务器的 FQDN 和ONTAP应用于与ONTAP S3 进行 HTTPS 通信的端口，选择访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。link:prev-ontap-backup-onprem-ontaps3.html["查看有关这些要求的详细信息"]。






.结果
卷、文件夹或文件已恢复，您将返回到恢复仪表板，以便您可以查看恢复操作的进度。您还可以选择“*作业监控*”选项卡来查看恢复进度。看link:br-use-monitor-tasks.html["作业监控页面"]。
