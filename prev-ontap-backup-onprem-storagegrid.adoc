---
sidebar: sidebar 
permalink: prev-ontap-backup-onprem-storagegrid.html 
keywords: backing up, back up, backup, backup application data, Amazon Web services, AWS, NetApp Backup and Recovery, Oracle database, Microsoft SQL Server database, SAP HANA database 
summary: 完成NetApp备份和恢复中的几个步骤，开始将卷数据从本地主ONTAP系统备份到二级存储系统以及NetApp StorageGRID系统中的对象存储。 
---
= 使用NetApp备份和恢复将本地ONTAP数据备份到StorageGRID
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
完成NetApp备份和恢复中的几个步骤，开始将卷数据从本地主ONTAP系统备份到二级存储系统以及NetApp StorageGRID系统中的对象存储。


NOTE: “本地ONTAP系统”包括FAS、 AFF和ONTAP Select系统。

[]
====
*注意* 要切换到NetApp备份和恢复工作负载，请参阅link:br-start-switch-ui.html["切换到不同的NetApp备份和恢复工作负载"]。

====


== 识别连接方法

下图显示了将本地ONTAP系统备份到StorageGRID时的每个组件以及您需要在它们之间准备的连接。

或者，您可以连接到同一本地位置的辅助ONTAP系统来复制卷。

image:diagram_cloud_backup_onprem_storagegrid.png["该图显示了NetApp Backup and Recovery 如何与源系统上的卷以及备份文件所在的目标存储进行通信。"]

当控制台代理和本地ONTAP系统安装在没有互联网访问的本地位置（“暗站”）时， StorageGRID系统必须位于同一个本地数据中心。暗站配置不支持将旧备份文件存档到公共云。



== 准备控制台代理

控制台代理是控制台功能的主要软件。需要控制台代理来备份和恢复您的ONTAP数据。



=== 创建或切换控制台代理

当您将数据备份到StorageGRID时，您的场所必须有控制台代理。您需要安装新的控制台代理或确保当前选择的控制台代理位于本地。控制台代理可以安装在有或没有互联网访问的站点。

* https://docs.netapp.com/us-en/console-setup-admin/concept-connectors.html["了解控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-quick-start-connector-on-prem.html["在具有互联网访问权限的 Linux 主机上安装控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-quick-start-private-mode.html["在没有互联网访问的 Linux 主机上安装控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-manage-multiple-connectors.html#switch-between-connectors["在控制台代理之间切换"^]




=== 准备控制台代理网络要求

确保安装控制台代理的网络启用以下连接：

* 通过端口 443 到StorageGRID网关节点的 HTTPS 连接
* 通过端口 443 建立到ONTAP集群管理 LIF 的 HTTPS 连接
* 通过端口 443 到NetApp Backup and Recovery 的出站互联网连接（当控制台代理安装在“暗站”时不需要）




==== 私人模式（暗站）注意事项

* NetApp备份和恢复功能内置于控制台代理中。当以私人模式安装时，您需要定期更新控制台代理软件才能访问新功能。检查link:whats-new.html["NetApp备份和恢复新功能"]查看每个NetApp Backup and Recovery 版本中的新功能。当您想要使用新功能时，请按照以下步骤操作 https://docs.netapp.com/us-en/console-setup-admin/task-upgrade-connector.html["升级控制台代理软件"^]。
+
NetApp Backup and Recovery 的新版本除了可以创建对象存储备份外，还具有安排和创建 Snapshot 副本和复制卷的功能，要求您使用控制台代理的 3.9.31 或更高版本。因此建议您获取此最新版本来管理所有备份。

* 当您在 SaaS 环境中使用NetApp Backup and Recovery 时， NetApp Backup and Recovery 配置数据将备份到云端。当您在没有互联网访问的站点中使用NetApp Backup and Recovery 时， NetApp Backup and Recovery 配置数据将备份到存储备份的StorageGRID桶中。




== 验证许可证要求

在为集群激活NetApp Backup and Recovery 之前，您需要从NetApp购买并激活NetApp Backup and Recovery BYOL 许可证。此许可证适用于该帐户，可跨多个系统使用。

您需要NetApp提供的序列号，以便您在许可证的有效期和容量内使用该服务。link:br-start-licensing.html["了解如何管理您的 BYOL 许可证"] 。


TIP: 将文件备份到StorageGRID时不支持 PAYGO 许可。



== 准备ONTAP集群

您需要准备源本地ONTAP系统以及任何辅助本地ONTAP或Cloud Volumes ONTAP系统。

准备ONTAP集群涉及以下步骤：

* 在NetApp控制台中发现您的ONTAP系统
* 验证ONTAP系统要求
* 验证ONTAP网络要求以将数据备份到对象存储
* 验证ONTAP复制卷的网络要求




=== 在NetApp控制台中发现您的ONTAP系统

您的源本地ONTAP系统和任何辅助本地ONTAP或Cloud Volumes ONTAP系统都必须在NetApp控制台 *系统* 页面上可用。

您需要知道集群管理 IP 地址和管理员用户帐户的密码才能添加集群。https://docs.netapp.com/us-en/storage-management-ontap-onprem/task-discovering-ontap.html["了解如何发现集群"^] 。



=== 验证ONTAP系统要求

确保满足以下ONTAP要求：

* 最低版本为ONTAP 9.8；建议使用ONTAP 9.8P13 及更高版本。
* SnapMirror许可证（包含在高级捆绑包或数据保护捆绑包中）。
+
*注意：*使用NetApp备份和恢复时不需要“混合云捆绑包”。

+
了解如何 https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html["管理您的集群许可证"^]。

* 时间和时区设置正确。了解如何 https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html["配置集群时间"^]。
* 如果要复制数据，则应在复制数据之前验证源系统和目标系统是否运行兼容的ONTAP版本。
+
https://docs.netapp.com/us-en/ontap/data-protection/compatible-ontap-versions-snapmirror-concept.html["查看与SnapMirror关系兼容的ONTAP版本"^] 。





=== 验证ONTAP网络要求以将数据备份到对象存储

您必须在连接到对象存储的系统上配置以下要求。

* 当您使用扇出备份架构时，必须在主存储系统上配置以下设置。
* 当您使用级联备份架构时，必须在_辅助_存储系统上配置以下设置。


需要满足以下ONTAP集群网络要求：

* ONTAP集群通过用户指定的端口从集群间 LIF 启动到StorageGRID网关节点的 HTTPS 连接，以执行备份和还原操作。该端口可在备份设置期间配置。
+
ONTAP从对象存储中读取和写入数据。对象存储从不启动，它只是响应。

* ONTAP需要从控制台代理到集群管理 LIF 的入站连接。控制台代理必须位于您的场所。
* 每个托管要备份的卷的ONTAP节点上都需要一个集群间 LIF。  LIF 必须与ONTAP用于连接对象存储的 _IPspace_ 相关联。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["了解有关 IP 空间的更多信息"^] 。
+
设置NetApp Backup and Recovery 时，系统会提示您输入要使用的 IP 空间。您应该选择与每个 LIF 关联的 IP 空间。这可能是“默认” IP 空间或您创建的自定义 IP 空间。

* 节点的集群间 LIF 能够访问对象存储（当控制台代理安装在“暗”站点中时不需要）。
* 已为卷所在的存储虚拟机配置 DNS 服务器。了解如何 https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html["为 SVM 配置 DNS 服务"^]。
* 如果您使用的 IP 空间与默认 IP 空间不同，则可能需要创建静态路由才能访问对象存储。
* 如有必要，请更新防火墙规则，以允许NetApp备份和恢复服务通过您指定的端口（通常为端口 443）从ONTAP连接到对象存储，并通过端口 53（TCP/UDP）从存储虚拟机到 DNS 服务器的名称解析流量。




=== 验证ONTAP复制卷的网络要求

如果您计划使用NetApp Backup and Recovery 在辅助ONTAP系统上创建复制卷，请确保源系统和目标系统满足以下网络要求。



==== 本地ONTAP网络要求

* 如果集群位于您的场所，您应该从公司网络连接到云提供商中的虚拟网络。这通常是 VPN 连接。
* ONTAP集群必须满足额外的子网、端口、防火墙和集群要求。
+
由于您可以复制到Cloud Volumes ONTAP或本地系统，因此请查看本地ONTAP系统的对等要求。 https://docs.netapp.com/us-en/ontap-sm-classic/peering/reference_prerequisites_for_cluster_peering.html["查看ONTAP文档中的集群对等前提条件"^] 。





==== Cloud Volumes ONTAP网络要求

* 实例的安全组必须包含所需的入站和出站规则：具体来说，ICMP 和端口 11104 和 11105 的规则。这些规则包含在预定义的安全组中。




== 准备StorageGRID作为备份目标

StorageGRID必须满足以下要求。查看 https://docs.netapp.com/us-en/storagegrid-117/["StorageGRID文档"^]了解更多信息。

有关StorageGRID的 DataLock 和勒索软件恢复要求的详细信息，请参阅link:prev-ontap-policy-object-options.html["备份到对象策略选项"]。

支持的StorageGRID版本:: 支持StorageGRID 10.3 及更高版本。
+
--
要使用 DataLock 和 Ransomware Resilience 进行备份，您的StorageGRID系统必须运行 11.6.0.3 或更高版本。

要将旧备份分层到云档案存储，您的StorageGRID系统必须运行 11.3 或更高版本。此外，您的StorageGRID系统必须在控制台*系统*页面上被发现。

对于用户档案存储，需要管理节点 IP 访问。

始终需要网关 IP 访问。

--
S3 凭证:: 您必须创建 S3 租户帐户来控制对StorageGRID存储的访问。 https://docs.netapp.com/us-en/storagegrid-117/admin/creating-tenant-account.html["有关详细信息，请参阅StorageGRID文档"^] 。
+
--
当您设置备份到StorageGRID时，备份向导会提示您输入租户帐户的 S3 访问密钥和密钥。租户帐户使NetApp Backup and Recovery 能够验证和访问用于存储备份的StorageGRID桶。需要密钥，以便StorageGRID知道谁在发出请求。

这些访问密钥必须与具有以下权限的用户相关联：

[source, json]
----
"s3:ListAllMyBuckets",
"s3:ListBucket",
"s3:GetObject",
"s3:PutObject",
"s3:DeleteObject",
"s3:CreateBucket"
----
--
对象版本控制:: 您不能在对象存储桶上手动启用StorageGRID对象版本控制。




=== 准备将较旧的备份文件存档到公共云存储

将较旧的备份文件分层到档案存储中可以节省资金，因为您可以使用较便宜的存储类来存储您可能不需要的备份。 StorageGRID是一种内部部署（私有云）解决方案，不提供档案存储，但您可以将较旧的备份文件移动到公共云档案存储。以这种方式使用时，分层到云存储的数据或从云存储恢复的数据会在StorageGRID和云存储之间传输 - 控制台不参与此数据传输。

当前支持使您能够将备份存档到 AWS _S3 Glacier_/_S3 Glacier Deep Archive_ 或 _Azure Archive_ 存储。

* ONTAP要求*

* 您的集群必须使用ONTAP 9.12.1 或更高版本。


* StorageGRID要求*

* 您的StorageGRID必须使用 11.4 或更高版本。
* 您的StorageGRID必须 https://docs.netapp.com/us-en/storage-management-storagegrid/task-discover-storagegrid.html["在控制台中发现并可用"^]。


*Amazon S3 要求*

* 您需要注册一个 Amazon S3 帐户，用于存储存档备份所在的存储空间。
* 您可以选择将备份分层到 AWS S3 Glacier 或 S3 Glacier Deep Archive 存储。link:prev-reference-aws-archive-storage-tiers.html["了解有关 AWS 存档层的更多信息"] 。
* StorageGRID应该对存储桶具有完全控制访问权限(`s3:*`）；但是，如果这不可能，则存储桶策略必须向StorageGRID授予以下 S3 权限：
+
** `s3:AbortMultipartUpload`
** `s3:DeleteObject`
** `s3:GetObject`
** `s3:ListBucket`
** `s3:ListBucketMultipartUploads`
** `s3:ListMultipartUploadParts`
** `s3:PutObject`
** `s3:RestoreObject`




Azure Blob 要求

* 您需要注册 Azure 订阅，以获取存档备份所在的存储空间。
* 激活向导使您能够使用现有的资源组来管理将存储备份的 Blob 容器，或者您可以创建一个新的资源组。


在为集群的备份策略定义存档设置时，您将输入云提供商凭据并选择要使用的存储类。当您激活集群备份时， NetApp Backup and Recovery 会创建云存储桶。  AWS 和 Azure 档案存储所需的信息如下所示。

image:screenshot_sg_archive_to_cloud.png["将备份文件从StorageGRID到 AWS S3 或 Azure Blob 所需信息的屏幕截图。"]

您选择的归档策略设置将在StorageGRID中生成信息生命周期管理 (ILM) 策略，并将这些设置添加为“规则”。

* 如果存在现有的活动 ILM 策略，则会将新规则添加到 ILM 策略中以将数据移动到存档层。
* 如果存在处于“建议”状态的现有 ILM 策略，则无法创建和激活新的 ILM 策略。 https://docs.netapp.com/us-en/storagegrid-117/ilm/index.html["了解有关StorageGRID ILM 策略和规则的更多信息"^] 。




== 激活ONTAP卷上的备份

随时直接从您的本地系统激活备份。

向导将引导您完成以下主要步骤：

* <<选择要备份的卷>>
* <<定义备份策略>>
* <<检查您的选择>>


您还可以<<显示 API 命令>>在审查步骤中，您可以复制代码来自动为未来的系统激活备份。



=== 启动向导

.步骤
. 使用以下方式之一访问激活备份和恢复向导：
+
** 从控制台*系统*页面中，选择系统，然后选择右侧面板中备份和恢复旁边的*启用>备份卷*。
+
如果备份目标在控制台*系统*页面上作为系统存在，则可以将ONTAP集群拖到对象存储上。

** 在备份和恢复栏中选择*卷*。从“卷”选项卡中，选择“操作 (...)”选项，然后为单个卷（尚未启用复制或备份到对象存储）选择“激活备份”。


+
向导的介绍页面显示保护选项，包括本地快照、复制和备份。如果您在此步骤中选择了第二个选项，则会出现“定义备份策略”页面，其中选择一个卷。

. 继续以下选项：
+
** 如果您已经有控制台代理，那么一切就绪了。只需选择*下一步*。
** 如果您还没有控制台代理，则会出现“添加控制台代理”选项。请参阅<<准备控制台代理>> 。






=== 选择要备份的卷

选择您想要保护的卷。受保护的卷是具有以下一项或多项的卷：快照策略、复制策略、备份到对象策略。

您可以选择保护FlexVol或FlexGroup卷；但是，在激活系统备份时不能选择这些卷的混合。了解如何link:prev-ontap-backup-manage.html["激活系统中附加卷的备份"]（FlexVol或FlexGroup）在为初始卷配置备份后。

[NOTE]
====
* 您一次只能在单个FlexGroup卷上激活备份。
* 您选择的卷必须具有相同的SnapLock设置。所有卷都必须启用SnapLock Enterprise或禁用SnapLock 。


====
.步骤
如果您选择的卷已经应用了快照或复制策略，那么您稍后选择的策略将覆盖这些现有策略。

. 在“选择卷”页面中，选择要保护的一个或多个卷。
+
** 或者，过滤行以仅显示具有特定卷类型、样式等的卷，以便更轻松地进行选择。
** 选择第一个卷后，您可以选择所有FlexVol卷（FlexGroup卷一次只能选择一个）。要备份所有现有的FlexVol卷，请先选中一个卷，然后选中标题行中的框。
** 要备份单个卷，请选中每个卷对应的复选框。


. 选择“下一步”。




=== 定义备份策略

定义备份策略涉及设置以下选项：

* 您是否需要一个或所有备份选项：本地快照、复制和备份到对象存储
* 架构
* 本地快照策略
* 复制目标和策略
+

NOTE: 如果您选择的卷具有与您在此步骤中选择的策略不同的快照和复制策略，则现有策略将被覆盖。

* 备份到对象存储信息（提供商、加密、网络、备份策略和导出选项）。


.步骤
. 在“定义备份策略”页面中，选择以下一项或全部。默认情况下，所有三个都被选中：
+
** *本地快照*：如果您正在执行复制或备份到对象存储，则必须创建本地快照。
** *复制*：在另一个ONTAP存储系统上创建复制卷。
** *备份*：将卷备份到对象存储。


. *架构*：如果您同时选择了复制和备份，请选择以下信息流之一：
+
** *级联*：信息从主存储流向辅助存储，然后从辅助存储流向对象存储。
** *扇出*：信息从主存储流向辅助存储，再从主存储流向对象存储。
+
有关这些架构的详细信息，请参阅link:prev-ontap-protect-journey.html["规划您的保护之旅"]。



. *本地快照*：选择现有的快照策略或创建新的快照策略。
+

TIP: 要创建自定义策略，请参阅link:br-use-policies-create.html["创建策略"]。

+
要创建策略，请选择“创建新策略”并执行以下操作：

+
** 输入策略的名称。
** 选择最多五个时间表，通常频率不同。
** 选择“*创建*”。


. *复制*：设置以下选项：
+
** *复制目标*：选择目标系统和 SVM。或者，选择将添加到复制卷名称的目标聚合或聚合以及前缀或后缀。
** *复制策略*：选择现有的复制策略或创建一个。
+

TIP: 要创建自定义策略，请参阅link:br-use-policies-create.html["创建策略"]。

+
要创建策略，请选择“创建新策略”并执行以下操作：

+
*** 输入策略的名称。
*** 选择最多五个时间表，通常频率不同。
*** 选择“*创建*”。




. *备份到对象*：如果您选择了*备份*，请设置以下选项：
+
** *提供商*：选择* StorageGRID*。
** *提供商设置*：输入提供商网关节点 FQDN 详细信息、端口、访问密钥和密钥。
+
访问密钥和密钥适用于您创建的 IAM 用户，用于授予ONTAP集群对存储桶的访问权限。

** *网络*：选择要备份的卷所在的ONTAP集群中的 IP 空间。此 IP 空间的集群间 LIF 必须具有出站互联网访问权限（当控制台代理安装在“暗站”中时不需要）。
+

TIP: 选择正确的 IP 空间可确保NetApp Backup and Recovery 可以建立从ONTAP到StorageGRID对象存储的连接。

** *备份策略*：选择现有的备份到对象存储策略或创建一个。
+

TIP: 要创建自定义策略，请参阅link:br-use-policies-create.html["创建策略"]。

+
要创建策略，请选择“创建新策略”并执行以下操作：

+
*** 输入策略的名称。
*** 选择最多五个时间表，通常频率不同。
*** 对于备份到对象策略，设置 DataLock 和 Ransomware Resilience 设置。有关 DataLock 和勒索软件恢复的详细信息，请参阅link:prev-ontap-policy-object-options.html["备份到对象策略设置"]。
+
如果您的集群使用的是ONTAP 9.11.1 或更高版本，您可以选择通过配置“DataLock”和“Ransomware Resilience”来保护您的备份免遭删除和勒索软件攻击。  _DataLock_ 保护您的备份文件不被修改或删除，而 _Ransomware Resilience_ 会扫描您的备份文件以查找备份文件中勒索软件攻击的证据。

*** 选择“*创建*”。




+
如果您的集群使用的是ONTAP 9.12.1 或更高版本，并且您的StorageGRID系统使用的是 11.4 或更高版本，您可以选择在一定天数后将旧备份分层到公共云存档层。当前支持 AWS S3 Glacier/S3 Glacier Deep Archive 或 Azure Archive 存储层。<<准备将较旧的备份文件存档到公共云存储,了解如何配置您的系统以实现此功能>> 。

+
** *分层备份到公共云*：选择您想要分层备份的云提供商并输入提供商详细信息。
+
选择或创建一个新的StorageGRID集群。有关创建StorageGRID集群以便控制台可以发现它的详细信息，请参阅 https://docs.netapp.com/us-en/storagegrid-117/["StorageGRID文档"^]。

** *将现有的 Snapshot 副本导出到对象存储作为备份副本*：如果此系统中有任何卷的本地快照副本与您刚刚为此系统选择的备份计划标签（例如，每日、每周等）相匹配，则会显示此附加提示。选中此框可将所有历史快照复制到对象存储作为备份文件，以确保对您的卷进行最全面的保护。


. 选择“下一步”。




=== 检查您的选择

这是审查您的选择并在必要时进行调整的机会。

.步骤
. 在“审核”页面中，审核您的选择。
. （可选）选中复选框*自动将快照策略标签与复制和备份策略标签同步*。这将创建具有与复制和备份策略中的标签匹配的标签的快照。
. 选择*激活备份*。


.结果
NetApp Backup and Recovery 开始对您的卷进行初始备份。复制卷和备份文件的基线传输包括源数据的完整副本。后续传输包含 Snapshot 副本中包含的主存储数据的差异副本。

在目标集群中创建一个复制卷，该卷将与主存储卷同步。

在您输入的 S3 访问密钥和密钥指示的服务帐户中创建一个 S3 存储桶，并将备份文件存储在那里。

显示卷备份仪表板，以便您可以监控备份的状态。

您还可以使用link:br-use-monitor-tasks.html["作业监控页面"^]。



=== 显示 API 命令

您可能想要显示并选择性地复制激活备份和恢复向导中使用的 API 命令。您可能希望这样做以便在未来的系统中自动激活备份。

.步骤
. 从激活备份和恢复向导中，选择*查看 API 请求*。
. 要将命令复制到剪贴板，请选择*复制*图标。

