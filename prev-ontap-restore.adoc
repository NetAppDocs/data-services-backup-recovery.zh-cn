---
sidebar: sidebar 
permalink: prev-ontap-restore.html 
keywords: backing up, back up, backup, backup application data, Amazon Web services, AWS, NetApp Backup and Recovery, Oracle database, Microsoft SQL Server database, SAP HANA database 
summary: 使用NetApp备份和恢复，可以从备份文件还原整个ONTAP卷，或者如果只需要还原几个文件，则可以还原文件夹或单个文件。 
---
= 使用NetApp Backup and Recovery 从备份文件恢复ONTAP数据
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
您可以从创建备份的位置获取ONTAP卷数据的备份：Snapshot 副本、复制的卷以及存储在对象存储中的备份。您可以从这些备份位置中的任何一个恢复特定时间点的数据。使用NetApp备份和恢复，可以从备份文件还原整个ONTAP卷，或者如果只需要还原几个文件，则可以还原文件夹或单个文件。

[]
====
*注意* 要切换到NetApp备份和恢复工作负载，请参阅link:br-start-switch-ui.html["切换到不同的NetApp备份和恢复工作负载"]。

====
* 您可以将*卷*（作为新卷）还原到原始系统、使用相同云帐户的其他系统或本地ONTAP系统。
* 您可以将*文件夹*还原到原始系统中的卷、使用相同云帐户的不同系统中的卷或本地ONTAP系统上的卷。
* 您可以将*文件*还原到原始系统中的卷、使用相同云帐户的不同系统中的卷或本地ONTAP系统上的卷。


需要有效的NetApp备份和恢复许可证才能将数据从备份文件恢复到生产系统。

总而言之，这些是可用于将卷数据还原到ONTAP系统的有效流程：

* 备份文件 -> 恢复卷
* 复制卷 -> 恢复卷
* 快照副本 -> 恢复卷



NOTE: 如果还原操作未完成，请不要再次尝试还原过程，直到作业监视器显示还原操作失败。如果在作业监视器显示还原操作失败之前再次尝试还原过程，则还原操作将再次失败。当您看到作业监视器状态为“失败”时，您可以再次尝试恢复过程。


NOTE: 有关还原ONTAP数据的限制，请参阅link:br-reference-limitations.html["ONTAP卷的备份和还原限制"]。



== 恢复仪表板

您可以使用还原仪表板执行卷、文件夹和文件还原操作。您可以通过单击控制台菜单中的“备份和恢复”，然后单击“恢复”选项卡来访问恢复仪表板。您还可以点击image:icon-options-vertical.gif["更多按钮"]> 从服务面板的备份和恢复服务中*查看恢复仪表板*。


NOTE: NetApp Backup and Recovery 必须已为至少一个系统激活，并且必须存在初始备份文件。

恢复仪表板提供了两种从备份文件恢复数据的不同方法：*浏览和恢复*和*搜索和恢复*。



== 比较“浏览和还原”与“搜索和还原”

广义上讲，当您需要恢复上周或上个月的特定卷、文件夹或文件时，_浏览和恢复_通常更好——并且您知道文件的名称和位置，以及它最后处于良好状态的日期。当您需要恢复卷、文件夹或文件，但不记得确切的名称、它所在的卷或它最后处于良好状态的日期时，_搜索和恢复_通常会更好。

该表提供了两种方法的功能比较。

[cols="50,50"]
|===
| 浏览和恢复 | 搜索和恢复 


| 浏览文件夹样式结构以查找单个备份文件中的卷、文件夹或文件。 | 通过部分或完整卷名、部分或完整文件夹/文件名、大小范围和其他搜索过滤器，在*所有备份文件*中搜索卷、文件夹或文件。 


| 如果文件已被删除或重命名，并且用户不知道原始文件名，则不处理文件恢复 | 处理新创建/删除/重命名的目录和新创建/删除/重命名的文件 


| 无需额外的云提供商资源 | 当您从云端恢复时，每个帐户需要额外的存储桶和公共云提供商资源。 


| 无需额外的云提供商成本 | 当您从云端恢复时，扫描备份和卷以获取搜索结果需要额外的费用。 


| 支持快速恢复。 | 不支持快速恢复。 
|===
该表根据备份文件所在的位置提供了有效还原操作的列表。

[cols="14h,14,14,14,14,14,14"]
|===
| 备份类型 3+| 浏览和恢复 3+| 搜索和恢复 


|  | *恢复音量* | *恢复文件* | *恢复文件夹* | *恢复音量* | *恢复文件* | *恢复文件夹* 


| Snapshot 副本 | 是 | 否 | 否 | 是 | 是 | 是 


| 复制卷 | 是 | 否 | 否 | 是 | 是 | 是 


| 备份文件 | 是 | 是 | 是 | 是 | 是 | 是 
|===
在使用任一恢复方法之前，请确保您已针对独特的资源要求配置了环境。这些要求在以下章节中描述。

请参阅要使用的还原操作类型的要求和还原步骤：

* <<使用“浏览和恢复”恢复卷,使用“浏览和恢复”恢复卷>>
* <<使用“浏览和恢复”功能恢复文件夹和文件,使用“浏览和恢复”功能恢复文件夹和文件>>
* <<restore-ontap-data-using-search-restore,使用“搜索和还原”功能还原卷、文件夹和文件>>




== 使用“浏览和还原”功能还原ONTAP数据

在开始还原卷、文件夹或文件之前，您应该知道要从中还原的卷的名称、卷所在的系统和 SVM 的名称以及要从中还原的备份文件的大致日期。您可以从 Snapshot 副本、复制的卷或存储在对象存储中的备份中恢复ONTAP数据。

*注意：*如果包含要恢复的数据的备份文件位于存档云存储中（从ONTAP 9.10.1 开始），则恢复操作将花费更长的时间并产生费用。此外，目标集群还必须运行ONTAP 9.10.1 或更高版本才能进行卷还原、9.11.1 才能进行文件还原、9.12.1 才能进行 Google Archive 和StorageGRID还原，以及 9.13.1 才能进行文件夹还原。

ifdef::aws[]

link:prev-reference-aws-archive-storage-tiers.html["了解有关从 AWS 档案存储恢复的更多信息"] 。

endif::aws[]

ifdef::azure[]

link:prev-reference-azure-archive-storage-tiers.html["了解有关从 Azure 档案存储还原的详细信息"] 。

endif::azure[]

ifdef::gcp[]

link:prev-reference-gcp-archive-storage-tiers.html["详细了解如何从 Google 存档存储中恢复"] 。

endif::gcp[]


NOTE: 将数据从 Azure 档案存储还原到StorageGRID系统时不支持高优先级。



=== 浏览并恢复支持的系统和对象存储提供商

您可以将ONTAP数据从位于二级系统（复制卷）或对象存储（备份文件）中的备份文件还原到以下系统。快照副本驻留在源系统上，并且只能还原到同一系统。

*注意：*您可以从任何类型的备份文件恢复卷，但目前只能从对象存储中的备份文件恢复文件夹或单个文件。

[cols="25,25,25,25"]
|===
| *来自对象存储（备份）* | *来自主（快照）* | *来自辅助系统（复制）* | 到目标系统 ifdef::aws[] 


| Amazon S3 | AWS 本地ONTAP系统中的Cloud Volumes ONTAP | AWS 本地ONTAP系统中的Cloud Volumes ONTAP endif::aws[] ifdef::azure[] | Azure Blob 


| Azure 本地ONTAP系统中的Cloud Volumes ONTAP | Azure 中的Cloud Volumes ONTAP本地ONTAP系统 endif::azure[] ifdef::gcp[] | Google Cloud Storage | Google 本地ONTAP系统中的Cloud Volumes ONTAP 


| Google 本地ONTAP系统中的Cloud Volumes ONTAP endif::gcp[] | NetAppStorageGRID | 本地ONTAP系统 | 本地ONTAP系统Cloud Volumes ONTAP 


| 到本地ONTAP系统 | ONTAP S3 | 本地ONTAP系统 | 本地ONTAP系统Cloud Volumes ONTAP 
|===
ifdef::aws[]

endif::aws[]

ifdef::azure[]

endif::azure[]

ifdef::gcp[]

endif::gcp[]

对于浏览和恢复，控制台代理可以安装在以下位置：

ifdef::aws[]

* 对于 Amazon S3，控制台代理可以部署在 AWS 或您的场所


endif::aws[]

ifdef::azure[]

* 对于 Azure Blob，控制台代理可以部署在 Azure 中或您的本地


endif::azure[]

ifdef::gcp[]

* 对于 Google Cloud Storage，控制台代理必须部署在您的 Google Cloud Platform VPC 中


endif::gcp[]

* 对于StorageGRID，控制台代理必须部署在您的场所；无论是否有互联网访问
* 对于ONTAP S3，控制台代理可以部署在您的场所（有或没有互联网访问）或云提供商环境中


请注意，“本地ONTAP系统”包括FAS、 AFF和ONTAP Select系统。


NOTE: 如果您系统上的ONTAP版本低于 9.13.1，并且备份文件已配置 DataLock 和勒索软件，则您无法恢复文件夹或文件。在这种情况下，您可以从备份文件恢复整个卷，然后访问所需的文件。



=== 使用“浏览和还原”还原卷

当您从备份文件恢复卷时， NetApp Backup and Recovery 会使用备份中的数据创建一个_新_卷。使用对象存储备份时，您可以将数据还原到原始系统中的卷、与源系统位于同一云帐户的其他系统或本地ONTAP系统。

将云备份还原到使用ONTAP 9.13.0 或更高版本的Cloud Volumes ONTAP系统或运行ONTAP 9.14.1 的本地ONTAP系统时，您可以选择执行_快速还原_操作。快速恢复非常适合需要尽快提供对卷的访问的灾难恢复情况。快速还原将备份文件中的元数据还原到卷，而不是还原整个备份文件。不建议对性能或延迟敏感的应用程序使用快速恢复，并且不支持归档存储中的备份。


NOTE: 仅当创建云备份的源系统运行ONTAP 9.12.1 或更高版本时， FlexGroup卷才支持快速还原。并且仅当源系统运行ONTAP 9.11.0 或更高版本时才支持SnapLock卷。

从复制卷还原时，您可以将卷还原到原始系统或Cloud Volumes ONTAP或本地ONTAP系统。

image:diagram_browse_restore_volume.png["该图显示了使用浏览和还原执行卷还原操作的流程。"]

如您所见，您需要知道源系统名称、存储虚拟机、卷名称和备份文件日期才能执行卷还原。

.步骤
. 从控制台菜单中，选择*保护>备份和恢复*。
. 选择“*恢复*”选项卡，将显示“恢复仪表板”。
. 从“浏览和恢复”部分，选择“恢复卷”。
. 在“选择源”页面中，导航到要恢复的卷的备份文件。选择具有要恢复的日期/时间戳的*系统*、*卷*和*备份*文件。
+
*位置*列显示备份文件（快照）是*本地*（源系统上的 Snapshot 副本）、*辅助*（辅助ONTAP系统上的复制卷）还是*对象存储*（对象存储中的备份文件）。选择您想要恢复的文件。

. 选择“下一步”。
+
请注意，如果您选择对象存储中的备份文件，并且该备份的勒索软件恢复功能处于活动状态（如果您在备份策略中启用了 DataLock 和勒索软件恢复功能），则系统会提示您在恢复数据之前对备份文件运行额外的勒索软件扫描。我们建议您扫描备份文件以查找勒索软件。（您将需要向云提供商支付额外的出口成本才能访问备份文件的内容。）

. 在“选择目标”页面中，选择要恢复卷的*系统*。
. 从对象存储还原备份文件时，如果您选择本地ONTAP系统并且尚未配置与对象存储的集群连接，系统将提示您输入其他信息：
+
ifdef::aws[]

+
** 从 Amazon S3 还原时，选择ONTAP集群中目标卷所在的 IP 空间，输入您创建的用户的访问密钥和密钥，以授予ONTAP集群对 S3 存储桶的访问权限，并可选择选择私有 VPC 端点以进行安全数据传输。




endif::aws[]

ifdef::azure[]

* 从 Azure Blob 还原时，选择目标卷所在的ONTAP集群中的 IP 空间，选择用于访问对象存储的 Azure 订阅，并通过选择 VNet 和子网来选择用于安全数据传输的私有端点。


endif::azure[]

ifdef::gcp[]

* 从 Google Cloud Storage 还原时，选择 Google Cloud 项目以及访问密钥和密钥来访问对象存储、存储备份的区域以及目标卷所在的ONTAP集群中的 IP 空间。


endif::gcp[]

* 从StorageGRID还原时，输入StorageGRID服务器的 FQDN 和ONTAP应用于与StorageGRID进行 HTTPS 通信的端口，选择访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。
* 从ONTAP S3 还原时，输入ONTAP S3 服务器的 FQDN 和ONTAP应用于与ONTAP S3 进行 HTTPS 通信的端口，选择访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。
+
.. 输入要用于恢复的卷的名称，然后选择卷所在的存储虚拟机和聚合。恢复FlexGroup卷时，您需要选择多个聚合。默认情况下，*<source_volume_name>_restore* 用作卷名。
+
当将备份从对象存储还原到使用ONTAP 9.13.0 或更高版本的Cloud Volumes ONTAP系统或运行ONTAP 9.14.1 的本地ONTAP系统时，您可以选择执行_快速还原_操作。

+
如果您要从位于归档存储层（从ONTAP 9.10.1 开始可用）中的备份文件还原卷，则可以选择还原优先级。

+
ifdef::aws[]





link:prev-reference-aws-archive-storage-tiers.html["了解有关从 AWS 档案存储恢复的更多信息"] 。

endif::aws[]

ifdef::azure[]

link:prev-reference-azure-archive-storage-tiers.html["了解有关从 Azure 档案存储还原的详细信息"] 。

endif::azure[]

ifdef::gcp[]

link:prev-reference-gcp-archive-storage-tiers.html["详细了解如何从 Google 存档存储中恢复"] 。Google Archive 存储层中的备份文件几乎可以立即恢复，并且不需要恢复优先级。

endif::gcp[]

. 选择“*下一步*”来选择是否执行正常还原或快速还原过程：
+
** *正常还原*：在需要高性能的卷上使用正常还原。还原过程完成之前，卷将不可用。
** *快速恢复*：恢复的卷和数据将立即可用。请勿在需要高性能的卷上使用此功能，因为在快速恢复过程中，访问数据的速度可能比平时慢。


. 选择“*恢复*”，您将返回到恢复仪表板，以便查看恢复操作的进度。


.结果
NetApp Backup and Recovery 根据您选择的备份创建一个新卷。

请注意，从驻留在档案存储中的备份文件恢复卷可能需要几分钟或几小时，具体取决于档案层和恢复优先级。您可以选择“作业监控”选项卡来查看恢复进度。



=== 使用“浏览和还原”还原文件夹和文件

如果您只需要从ONTAP卷备份中恢复几个文件，则可以选择恢复文件夹或单个文件，而不是恢复整个卷。您可以将文件夹和文件还原到原始系统中的现有卷，或还原到使用相同云帐户的其他系统。您还可以将文件夹和文件还原到本地ONTAP系统上的卷。


NOTE: 目前，您只能从对象存储中的备份文件恢复文件夹或单个文件。目前不支持从本地快照副本或驻留在辅助系统（复制卷）中的备份文件还原文件和文件夹。

如果您选择多个文件，则所有文件都将还原到您选择的同一目标卷。因此，如果您想将文件恢复到不同的卷，则需要多次运行恢复过程。

使用ONTAP 9.13.0 或更高版本时，您可以还原文件夹以及其中的所有文件和子文件夹。使用 9.13.0 之前的ONTAP版本时，仅恢复该文件夹中的文件 - 不会恢复子文件夹或子文件夹中的文件。

[NOTE]
====
* 如果备份文件已配置 DataLock 和勒索软件保护，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从备份文件恢复整个卷，然后访问所需的文件夹和文件。
* 如果备份文件驻留在档案存储中，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从尚未存档的较新备份文件中还原文件夹，也可以从存档的备份中还原整个卷，然后访问所需的文件夹和文件。
* 使用ONTAP 9.15.1，您可以使用“浏览和恢复”选项恢复FlexGroup文件夹。此功能处于技术预览模式。
+
您可以使用 https://community.netapp.com/t5/Tech-ONTAP-Blogs/BlueXP-Backup-and-Recovery-July-2024-Release/ba-p/453993#toc-hId-1830672444["NetApp备份和恢复 2024 年 7 月版本博客"^]。



====


==== 前提条件

* ONTAP版本必须为 9.6 或更高版本才能执行_文件_恢复操作。
* ONTAP版本必须为 9.11.1 或更高版本才能执行_文件夹_还原操作。如果数据位于档案存储中，或者备份文件使用 DataLock 和勒索软件保护，则需要ONTAP版本 9.13.1。
* ONTAP版本必须为 9.15.1 p2 或更高版本才能使用浏览和还原选项还原FlexGroup目录。




==== 文件夹和文件还原过程

这个过程如下：

. 当您想要从卷备份中恢复文件夹或一个或多个文件时，请单击“恢复”选项卡，然后单击“浏览和恢复”下的“恢复文件或文件夹”。
. 选择文件夹或文件所在的源系统、卷和备份文件。
. NetApp Backup and Recovery 显示所选备份文件中存在的文件夹和文件。
. 选择要从该备份中恢复的文件夹或文件。
. 选择要恢复文件夹或文件的目标位置（系统、卷和文件夹），然后单击“*恢复*”。
. 文件已恢复。


image:diagram_browse_restore_file.png["该图显示了使用浏览和恢复执行文件恢复操作的流程。"]

如您所见，您需要知道系统名称、卷名、备份文件日期和文件夹/文件名才能执行文件夹或文件还原。



==== 还原文件夹和文件

按照以下步骤将文件夹或文件从ONTAP卷备份还原到卷。您应该知道要用于恢复文件夹或文件的卷的名称和备份文件的日期。此功能使用实时浏览，以便您可以查看每个备份文件中的目录和文件列表。

.步骤
. 从控制台菜单中，选择*保护>备份和恢复*。
. 选择“*恢复*”选项卡，将显示“恢复仪表板”。
. 从“浏览和恢复”部分，选择“恢复文件或文件夹”。
. 在“选择源”页面中，导航到包含要还原的文件夹或文件的卷的备份文件。选择具有要从中恢复文件的日期/时间戳的*系统*、*卷*和*备份*。
. 选择“*下一步*”，将显示卷备份中的文件夹和文件列表。
+
如果您要从位于档案存储层的备份文件还原文件夹或文件，则可以选择还原优先级。

+
link:prev-reference-aws-archive-storage-tiers.html["了解有关从 AWS 档案存储恢复的更多信息"] 。link:prev-reference-azure-archive-storage-tiers.html["了解有关从 Azure 档案存储还原的详细信息"] 。link:prev-reference-gcp-archive-storage-tiers.html["详细了解如何从 Google 存档存储中恢复"] 。Google Archive 存储层中的备份文件几乎可以立即恢复，并且不需要恢复优先级。

+
如果备份文件的勒索软件恢复功能处于活动状态（如果您在备份策略中启用了 DataLock 和勒索软件恢复功能），则会提示您在恢复数据之前对备份文件运行额外的勒索软件扫描。我们建议您扫描备份文件以查找勒索软件。（您将需要向云提供商支付额外的出口成本才能访问备份文件的内容。）

. 在“选择项目”页面中，选择要恢复的文件夹或文件，然后选择“继续”。为了帮助您找到该物品：
+
** 如果看到文件夹或文件名，您可以选择它。
** 您可以选择搜索图标并输入文件夹或文件的名称以直接导航到该项目。
** 您可以使用行尾的向下箭头向下导航文件夹级别来查找特定文件。
+
当您选择文件时，它们会被添加到页面的左侧，以便您可以看到已经选择的文件。如果需要，您可以通过选择文件名旁边的 *x* 从此列表中删除文件。



. 在“选择目标”页面中，选择要恢复项目的*系统*。
+
如果您选择本地集群，并且尚未配置与对象存储的集群连接，系统将提示您输入其他信息：

+
ifdef::aws[]

+
** 从 Amazon S3 还原时，输入目标卷所在的ONTAP集群中的 IP 空间，以及访问对象存储所需的 AWS 访问密钥和密钥。您还可以选择专用链接配置来连接到集群。




endif::aws[]

ifdef::azure[]

* 从 Azure Blob 还原时，输入目标卷所在的ONTAP集群中的 IP 空间。您还可以为与集群的连接选择私有端点配置。


endif::azure[]

ifdef::gcp[]

* 从 Google Cloud Storage 恢复时，输入目标卷所在的ONTAP集群中的 IP 空间，以及访问对象存储所需的访问密钥和密钥。


endif::gcp[]

* 从StorageGRID还原时，输入StorageGRID服务器的 FQDN 和ONTAP应用于与StorageGRID进行 HTTPS 通信的端口，输入访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。
+
.. 然后选择要恢复文件夹或文件的*卷*和*文件夹*。
+
恢复文件夹和文件时，您有几个位置选项可供选择。



* 当您选择“选择目标文件夹”时，如上所示：
+
** 您可以选择任意文件夹。
** 您可以将鼠标悬停在文件夹上，然后单击行尾以深入查看子文件夹，然后选择一个文件夹。


* 如果您选择了与源文件夹/文件相同的目标系统和卷，则可以选择*维护源文件夹路径*将文件夹或文件还原到源结构中存在的同一文件夹。所有相同的文件夹和子文件夹必须已经存在；不会创建文件夹。将文件还原到原始位置时，您可以选择覆盖源文件或创建新文件。
+
.. 选择“*恢复*”，您将返回到恢复仪表板，以便您可以查看恢复操作的进度。您还可以单击“作业监控”选项卡来查看恢复进度。






== 使用“搜索和还原”还原ONTAP数据

您可以使用“搜索和还原”从ONTAP备份文件中还原卷、文件夹或文件。搜索和还原使您能够从所有备份中搜索特定的卷、文件夹或文件，然后执行还原。您不需要知道确切的系统名称、卷名或文件名——搜索会查看所有卷备份文件。

搜索操作会查看ONTAP卷中存在的所有本地快照副本、二级存储系统上的所有复制卷以及对象存储中存在的所有备份文件。由于从本地 Snapshot 副本或复制卷恢复数据比从对象存储中的备份文件恢复数据更快且成本更低，因此您可能希望从这些其他位置恢复数据。

当您从备份文件恢复_完整卷_时， NetApp Backup and Recovery 会使用备份中的数据创建一个_新_卷。您可以将数据作为原始系统中的卷还原到与源系统位于同一云帐户的其他系统或本地ONTAP系统。

您可以将文件夹或文件还原到原始卷位置、同一系统中的不同卷、使用同一云帐户的不同系统或本地ONTAP系统上的卷。

使用ONTAP 9.13.0 或更高版本时，您可以还原文件夹以及其中的所有文件和子文件夹。使用 9.13.0 之前的ONTAP版本时，仅恢复该文件夹中的文件 - 不会恢复子文件夹或子文件夹中的文件。

如果要还原的卷的备份文件位于档案存储中（从ONTAP 9.10.1 开始可用），则还原操作将花费更长的时间并产生额外的费用。请注意，目标集群还必须运行ONTAP 9.10.1 或更高版本才能进行卷还原、9.11.1 才能进行文件还原、9.12.1 才能进行 Google Archive 和StorageGRID，以及 9.13.1 才能进行文件夹还原。

ifdef::aws[]

link:prev-reference-aws-archive-storage-tiers.html["了解有关从 AWS 档案存储恢复的更多信息"] 。

endif::aws[]

ifdef::azure[]

link:prev-reference-azure-archive-storage-tiers.html["了解有关从 Azure 档案存储还原的详细信息"] 。

endif::azure[]

ifdef::gcp[]

link:prev-reference-gcp-archive-storage-tiers.html["详细了解如何从 Google 存档存储中恢复"] 。

endif::gcp[]

[NOTE]
====
* 如果对象存储中的备份文件已配置 DataLock 和勒索软件保护，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从备份文件恢复整个卷，然后访问所需的文件夹和文件。
* 如果对象存储中的备份文件驻留在档案存储中，则仅当ONTAP版本为 9.13.1 或更高版本时才支持文件夹级还原。如果您使用的是早期版本的ONTAP，则可以从尚未存档的较新备份文件中还原文件夹，也可以从存档的备份中还原整个卷，然后访问所需的文件夹和文件。
* 将数据从 Azure 档案存储还原到StorageGRID系统时，不支持“高”还原优先级。
* 目前不支持从ONTAP S3 对象存储中的卷还原文件夹。


====
在开始之前，您应该对要还原的卷或文件的名称或位置有所了解。



=== 搜索和恢复支持的系统和对象存储提供商

您可以将ONTAP数据从位于二级系统（复制卷）或对象存储（备份文件）中的备份文件还原到以下系统。快照副本驻留在源系统上，并且只能还原到同一系统。

*注意：*您可以从任何类型的备份文件恢复卷和文件，但目前只能从对象存储中的备份文件恢复文件夹。

[cols="33,33,33"]
|===
2+| 备份文件位置 | 目的地系统 


| *对象存储（备份）* | *辅助系统（复制）* | ifdef::aws[] 


| Amazon S3 | AWS 本地ONTAP系统中的Cloud Volumes ONTAP | AWS 本地ONTAP系统中的Cloud Volumes ONTAP endif::aws[] ifdef::azure[] 


| Azure Blob | Azure 本地ONTAP系统中的Cloud Volumes ONTAP | Azure 中的Cloud Volumes ONTAP本地ONTAP系统 endif::azure[] ifdef::gcp[] 


| Google Cloud Storage | Google 本地ONTAP系统中的Cloud Volumes ONTAP | Google 本地ONTAP系统中的Cloud Volumes ONTAP endif::gcp[] 


| NetAppStorageGRID | 本地ONTAP系统Cloud Volumes ONTAP | 本地ONTAP系统 


| ONTAP S3 | 本地ONTAP系统Cloud Volumes ONTAP | 本地ONTAP系统 
|===
对于搜索和还原，控制台代理可以安装在以下位置：

ifdef::aws[]

* 对于 Amazon S3，控制台代理可以部署在 AWS 或您的场所


endif::aws[]

ifdef::azure[]

* 对于 Azure Blob，控制台代理可以部署在 Azure 中或您的本地


endif::azure[]

ifdef::gcp[]

* 对于 Google Cloud Storage，控制台代理必须部署在您的 Google Cloud Platform VPC 中


endif::gcp[]

* 对于StorageGRID，控制台代理必须部署在您的场所；无论是否有互联网访问
* 对于ONTAP S3，控制台代理可以部署在您的场所（有或没有互联网访问）或云提供商环境中


请注意，“本地ONTAP系统”包括FAS、 AFF和ONTAP Select系统。



=== 前提条件

* 集群要求：
+
** ONTAP版本必须为 9.8 或更高版本。
** 卷所在的存储虚拟机 (SVM) 必须具有配置的数据 LIF。
** 必须在卷上启用 NFS（支持 NFS 和 SMB/CIFS 卷）。
** 必须在 SVM 上激活 SnapDiff RPC 服务器。当您在系统上启用索引时，控制台会自动执行此操作。  （SnapDiff 是一种快速识别 Snapshot 副本之间文件和目录差异的技术。）




ifdef::aws[]

* AWS 要求：
+
** 必须将特定的 Amazon Athena、AWS Glue 和 AWS S3 权限添加到为控制台提供权限的用户角色。link:prev-ontap-backup-onprem-aws.html["确保所有权限均已正确配置"] 。
+
请注意，如果您已经使用过去配置的控制台代理来使用NetApp Backup and Recovery，则现在需要将 Athena 和 Glue 权限添加到控制台用户角色。它们是搜索和恢复所必需的。





endif::aws[]

ifdef::azure[]

* Azure 要求：
+
** 您必须向您的订阅注册 Azure Synapse Analytics 资源提供程序（称为“Microsoft.Synapse”）。 https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types#register-resource-provider["了解如何为您的订阅注册此资源提供程序"^] 。您必须是订阅*所有者*或*贡献者*才能注册资源提供者。
** 必须将特定的 Azure Synapse Workspace 和 Data Lake Storage 帐户权限添加到为控制台提供权限的用户角色。link:prev-ontap-backup-onprem-azure.html["确保所有权限均已正确配置"] 。
+
请注意，如果您已经使用过去配置的控制台代理来使用NetApp Backup and Recovery，则现在需要将 Azure Synapse Workspace 和 Data Lake Storage 帐户权限添加到控制台用户角色。它们是搜索和恢复所必需的。

** 控制台代理必须配置为*不带*代理服务器才能与互联网进行 HTTP 通信。如果您已为控制台代理配置了 HTTP 代理服务器，则无法使用搜索和还原功能。




endif::azure[]

ifdef::gcp[]

* Google Cloud 要求：
+
** 必须将特定的 Google BigQuery 权限添加到为NetApp控制台提供权限的用户角色。link:prev-ontap-backup-onprem-gcp.html["确保所有权限均已正确配置"] 。
+
如果您已经使用NetApp Backup and Recovery 以及您过去配置的控制台代理，则现在需要将 BigQuery 权限添加到控制台用户角色。它们是搜索和恢复所必需的。





endif::gcp[]

* StorageGRID和ONTAP S3 要求：
+
根据您的配置，有两种方法可以实现“搜索和还原”：

+
** 如果您的帐户中没有云提供商凭据，则索引目录信息将存储在控制台代理上。
+
有关索引目录 v2 的信息，请参阅下面有关如何启用索引目录的部分。

** 如果您在私人（暗）站点中使用控制台代理，则索引目录信息将存储在控制台代理上（需要控制台代理版本 3.9.25 或更高版本）。
** 如果你有 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-aws.html["AWS 凭证"^]或者 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-azure.html["Azure 凭据"^]在帐户中，索引目录存储在云提供商处，就像在云中部署控制台代理一样。  （如果您拥有这两个凭证，则默认选择 AWS。）
+
即使您使用的是本地控制台代理，也必须满足控制台代理权限和云提供商资源的云提供商要求。使用此实现时，请参阅上面的 AWS 和 Azure 要求。







=== 搜索和恢复过程

这个过程如下：

. 在使用搜索和还原之前，您需要在要从中还原卷数据的每个源系统上启用“索引”。这使得索引目录可以跟踪每个卷的备份文件。
. 当您想要从卷备份中恢复卷或文件时，在“搜索和恢复”下选择“*搜索和恢复*”。
. 通过部分或完整卷名、部分或完整文件名、备份位置、大小范围、创建日期范围、其他搜索过滤器输入卷、文件夹或文件的搜索条件，然后选择*搜索*。
+
搜索结果页面显示具有符合搜索条件的文件或卷的所有位置。

. 选择要用于恢复卷或文件的位置的“查看所有备份”，然后在要使用的实际备份文件上选择“恢复”。
. 选择您想要恢复卷、文件夹或文件的位置，然后选择*恢复*。
. 卷、文件夹或文件已恢复。


image:diagram_search_restore_vol_file.png["该图显示了使用“搜索和还原”执行卷、文件夹或文件还原操作的流程。"]

如您所见，您实际上只需要知道部分名称， NetApp Backup and Recovery 就会搜索与您的搜索相匹配的所有备份文件。



=== 为每个系统启用索引目录

在使用搜索和还原之前，您需要在计划还原卷或文件的每个源系统上启用“索引”。这使得索引目录可以跟踪每个卷和每个备份文件 - 使您的搜索非常快速和高效。

索引目录是一个数据库，用于存储系统中所有卷和备份文件的元数据。搜索和恢复功能使用它来快速找到包含要恢复的数据的备份文件。

.索引目录 v2 功能
索引目录 v2 于 2025 年 2 月发布，并于 2025 年 6 月更新，其功能使其更高效、更易于使用。此版本具有显著的性能增强，并且默认为所有新客户启用。

回顾有关 v2 的以下注意事项：

* 索引目录 v2 处于预览模式。
* 如果您是现有客户并想要使用 Catalog v2，则需要完全重新索引您的环境。
* Catalog v2 仅索引具有快照标签的快照。
* NetApp Backup and Recovery 不会使用“每小时” SnapMirror标签对快照进行索引。如果您想使用“每小时” SnapMirror标签索引快照，则需要在 v2 处于预览模式时手动启用它。
* NetApp Backup and Recovery 将仅使用 Catalog v2 为受NetApp Backup and Recovery 保护的系统关联的卷和快照编制索引。在控制台平台上发现的其他系统将不会被编入索引。
* 使用 Catalog v2 进行数据索引发生在本地环境以及 Amazon Web Services、Microsoft Azure 和 Google Cloud Platform (GCP) 环境中。


索引目录 v2 支持以下内容：

* 3分钟内即可实现全球搜索效率
* 最多 50 亿个文件
* 每个集群最多 5000 个卷
* 每个卷最多 10 万个快照
* 基线索引的最长时间少于 7 天。实际时间将根据您的环境而有所不同。


.为系统启用索引目录
当您使用 Indexed Catalog v2 时，该服务不会提供单独的存储桶。相反，对于存储在 AWS、Azure、Google Cloud Platform、 StorageGRID或ONTAP S3 中的备份，该服务会在控制台代理或云提供商环境上提供空间。

如果您在 v2 版本之前启用了索引目录，则系统会出现以下情况：

* 对于存储在 AWS 中的备份，它会提供一个新的 S3 bucket 和 https://aws.amazon.com/athena/faqs/["Amazon Athena 交互式查询服务"^]和 https://aws.amazon.com/glue/faqs/["AWS Glue 无服务器数据集成服务"^]。
* 对于存储在 Azure 中的备份，它会提供一个 Azure Synapse 工作区和一个 Data Lake 文件系统作为存储工作区数据的容器。
* 对于存储在 Google Cloud 中的备份，它会配置一个新的存储桶，并且 https://cloud.google.com/bigquery["Google Cloud BigQuery 服务"^]在帐户/项目级别进行配置。
* 对于存储在StorageGRID或ONTAP S3 中的备份，它会在控制台代理或云提供商环境中提供空间。


如果您的系统已启用索引，请转至下一部分来恢复您的数据。

.为系统启用索引的步骤：
. 执行以下操作之一：
+
** 如果没有系统被索引，请在“恢复仪表板”的“搜索和恢复”下，选择“启用系统索引”。
** 如果至少有一个系统已被索引，请在“搜索和恢复”下的“恢复仪表板”上选择“索引设置”。


. 为系统选择*启用索引*。


.结果
在所有服务都配置完毕并且索引目录被激活后，系统将显示为“活动”状态。

根据系统中卷的大小以及所有 3 个备份位置的备份文件数量，初始索引过程可能需要长达一个小时。此后，它会每小时透明地更新，并进行增量更改以保持最新状态。



=== 使用“搜索和还原”功能还原卷、文件夹和文件

之后<<enable-the-indexed-catalog-for-each-working-environment,为您的系统启用索引>>，您可以使用“搜索和还原”还原卷、文件夹和文件。这使您可以使用广泛的过滤器从所有备份文件中找到要恢复的确切文件或卷。

.步骤
. 从控制台菜单中，选择*保护>备份和恢复*。
. 选择“*恢复*”选项卡，将显示“恢复仪表板”。
. 从“搜索和恢复”部分，选择“搜索和恢复”。
. 从“搜索和恢复”部分，选择“搜索和恢复”。
. 从“搜索和还原”页面：
+
.. 在“搜索栏”中，输入完整或部分卷名、文件夹名或文件名。
.. 选择资源类型：*卷*、*文件*、*文件夹*或*全部*。
.. 在“过滤依据”区域中，选择过滤条件。例如，您可以选择数据所在的系统和文件类型，例如 .JPEG 文件。或者，如果您只想在对象存储中的可用 Snapshot 副本或备份文件中搜索结果，则可以选择备份位置的类型。


. 选择*搜索*，搜索结果区域将显示所有具有与您的搜索相匹配的文件、文件夹或卷的资源。
. 找到包含您要恢复的数据的资源，然后选择“查看所有备份”以显示包含匹配卷、文件夹或文件的所有备份文件。
. 找到您想要用于恢复数据的备份文件并选择*恢复*。
+
请注意，结果会识别包含搜索到的文件的本地卷 Snapshot 副本和远程复制卷。您可以选择从云备份文件、Snapshot 副本或复制卷进行恢复。

. 选择要恢复卷、文件夹或文件的目标位置，然后选择*恢复*。
+
** 对于卷，您可以选择原始目标系统，也可以选择备用系统。恢复FlexGroup卷时，您需要选择多个聚合。
** 对于文件夹，您可以恢复到原始位置，也可以选择备用位置；包括系统、卷和文件夹。
** 对于文件，您可以恢复到原始位置，也可以选择备用位置；包括系统、卷和文件夹。选择原始位置时，您可以选择覆盖源文件或创建新文件。
+
如果您选择本地ONTAP系统，并且尚未配置与对象存储的集群连接，系统将提示您输入其他信息：

+
ifdef::aws[]

+
*** 从 Amazon S3 还原时，选择ONTAP集群中目标卷所在的 IP 空间，输入您创建的用户的访问密钥和密钥，以授予ONTAP集群对 S3 存储桶的访问权限，并可选择选择私有 VPC 端点以进行安全数据传输。link:prev-ontap-backup-onprem-aws.html["查看有关这些要求的详细信息"] 。






endif::aws[]

ifdef::azure[]

* 从 Azure Blob 还原时，选择目标卷所在的ONTAP集群中的 IP 空间，并通过选择 VNet 和子网来选择用于安全数据传输的私有端点。link:prev-ontap-backup-onprem-azure.html["查看有关这些要求的详细信息"] 。


endif::azure[]

ifdef::gcp[]

* 从 Google Cloud Storage 恢复时，选择目标卷所在的ONTAP集群中的 IP 空间，以及用于访问对象存储的访问密钥和密钥。link:prev-ontap-backup-onprem-gcp.html["查看有关这些要求的详细信息"] 。


endif::gcp[]

* 从StorageGRID还原时，输入StorageGRID服务器的 FQDN 和ONTAP应用于与StorageGRID进行 HTTPS 通信的端口，输入访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。link:prev-ontap-backup-onprem-storagegrid.html["查看有关这些要求的详细信息"] 。
* 从ONTAP S3 还原时，输入ONTAP S3 服务器的 FQDN 和ONTAP应用于与ONTAP S3 进行 HTTPS 通信的端口，选择访问对象存储所需的访问密钥和密钥，以及目标卷所在的ONTAP集群中的 IP 空间。link:prev-ontap-backup-onprem-ontaps3.html["查看有关这些要求的详细信息"] 。


.结果
卷、文件夹或文件已恢复，您将返回到恢复仪表板，以便您可以查看恢复操作的进度。您还可以选择“作业监控”选项卡来查看恢复进度。看link:br-use-monitor-tasks.html["作业监控页面"] 。
